import { _decorator, Component, Camera, input, Input, Vec2, PhysicsSystem, geometry, Vec3 } from 'cc';
import { StackManager } from './StackManager';
const { ccclass, property } = _decorator;

@ccclass('TapController')
export class TapController extends Component {

    @property(Camera)
    camera: Camera = null;

    @property(StackManager)
    stackManager: StackManager = null;

    private _ray: geometry.Ray = new geometry.Ray();

    start() {
        input.on(Input.EventType.TOUCH_START, this.onTouchStart, this);
    }

    onTouchStart(event: any) {
        const location = event.getLocation() as Vec2;

        if (!this.camera) return;
        if (!this.stackManager) return;

        // Generate ray from screen touch
        this.camera.screenPointToRay(location.x, location.y, this._ray);

        const mask = 0xffffffff; // collide with everything
        const result = PhysicsSystem.instance.raycastClosest(this._ray, mask);

        if (result) {
            const hit = PhysicsSystem.instance.raycastClosestResult;
            const hitPos = hit.hitPoint.clone();
            this.stackManager.placeBlock(hitPos);
        }
    }
}
