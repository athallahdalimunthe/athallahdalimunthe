extends Control

@onready var big_button: Button = $UILayer/BigButton
@onready var chaos_node: Node2D = $ChaosNode
@onready var effect_flash: TextureRect = $UILayer/EffectFlash
@onready var instruction_label: Label = $UILayer/InstructionLabel

var chaos_textures: Array[Texture2D] = []
var spawn_count := 0
var MAX_CHAOS := 250  # trillion dollar performance limit
var structure_value := 0


func _ready():
	randomize()
	load_chaos_assets()
	instruction_label.text = "PRESS TO INCREASE VALUE"


func load_chaos_assets():
	var dir := DirAccess.open("res://Assets")
	if dir:
		_load_dir_recursive(dir, "res://Assets")
	print("Loaded chaos textures: ", chaos_textures.size())


func _load_dir_recursive(dir: DirAccess, path: String):
	dir.list_dir_begin()
	var file := dir.get_next()

	while file != "":
		if file.begins_with("."):
			file = dir.get_next()
			continue

		var full_path := path + "/" + file

		if dir.current_is_dir():
			var sub := DirAccess.open(full_path)
			if sub:
				_load_dir_recursive(sub, full_path)
		else:
			if file.get_extension().to_lower() in ["png", "jpg", "jpeg", "webp"]:
				var tex := load(full_path)
				if tex:
					chaos_textures.append(tex)

		file = dir.get_next()

	dir.list_dir_end()


func increase_value():
	var gain := randi_range(1, 50)

	if randf() < 0.05:
		gain *= 10 # LEGENDARY MOMENT
		instruction_label.text = "LEGENDARY STRUXTURE"

	structure_value += gain
	big_button.text = "AthallahLynx1: " + str(structure_value)


func _on_BigButton_pressed():
	asset_explosion()
	random_flash()
	increase_value()
	update_instruction()


func asset_explosion():
	if chaos_textures.is_empty():
		return

	# HARD CHAOS CAP (FIXED INDENTATION)
	while chaos_node.get_child_count() > MAX_CHAOS:
		chaos_node.get_child(0).queue_free()

	for i in randi_range(1, 4):
		spawn_chaos_asset(chaos_textures.pick_random())

	# EXTRA INSANE SPRITE2D (KEPT)
	var sprite := Sprite2D.new()
	sprite.texture = chaos_textures.pick_random()
	sprite.position = Vector2(
		randf_range(0, get_viewport_rect().size.x),
		randf_range(0, get_viewport_rect().size.y)
	)
	sprite.rotation = randf_range(0, TAU)
	sprite.scale = Vector2.ONE * randf_range(0.2, 3.5)
	sprite.z_index = -10  # ALWAYS BELOW UI

	chaos_node.add_child(sprite)
	spawn_count += 1


func random_flash():
	if randf() < 0.3 and not chaos_textures.is_empty():
		effect_flash.texture = chaos_textures.pick_random()
		effect_flash.visible = true
		await get_tree().process_frame
		effect_flash.visible = false


func update_instruction():
	if spawn_count < 10:
		instruction_label.text = "keep MOVING."
	elif spawn_count < 30:
		instruction_label.text = "BUTTON INCREASING"
	elif spawn_count < 80:
		instruction_label.text = "stop pls JK KEEP GOING"
	elif spawn_count < 150:
		instruction_label.text = "WHAT IS THIS?!"
	else:
		instruction_label.text = "I am athallahLYNX"


func spawn_chaos_asset(texture: Texture2D):
	var sprite := TextureRect.new()
	sprite.texture = texture
	sprite.expand_mode = TextureRect.EXPAND_IGNORE_SIZE
	sprite.stretch_mode = TextureRect.STRETCH_KEEP_ASPECT
	sprite.custom_minimum_size = Vector2(120, 120)
	sprite.z_index = -10  # UI SAFETY

	# RANDOM POSITION
	var screen_size := get_viewport_rect().size
	sprite.position = Vector2(
		randf_range(0, screen_size.x - 120),
		randf_range(0, screen_size.y - 120)
	)

	# BAD TRANSFORM (INTENTIONAL)
	sprite.rotation = randf_range(-1.5, 1.5)
	sprite.scale = Vector2.ONE * randf_range(0.5, 1.5)

	chaos_node.add_child(sprite)

	# POOR MAN ANIMATION (KEPT)
	var tween := create_tween()
	tween.set_loops(2)
	tween.tween_property(sprite, "rotation", sprite.rotation + randf_range(-3, 3), 0.2)
	tween.tween_property(sprite, "scale", Vector2.ONE * randf_range(0.2, 2.5), 0.2)

	# BULLETPROOF AUTO-DELETE (NO STACKING BUGS)
	var timer := Timer.new()
	timer.one_shot = true
	timer.wait_time = randf_range(2.0, 3.0)
	sprite.add_child(timer)
	timer.start()
	timer.timeout.connect(sprite.queue_free)
